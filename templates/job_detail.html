<!doctype html>
<html>
<head><title>{{ header_title }}</title><link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"></head>
<body>
<header><h1 id="appTitle">{{ header_title }}</h1>
<nav><a href="{{ url_for('site_detail', site_id=site['id']) }}">← Back to Site</a> | <a href="{{ url_for('customers_index') }}">Customers</a></nav>
</header>
<main class="wrap">
<section class="card">
  <h2>{{ site['customer'] }} — {{ site['name'] }}</h2>
  <form method="post" action="{{ url_for('edit_job', site_id=site['id'], job_id=job['id']) }}" class="grid">
    <label>Job #<input name="job_number" value="{{ job['job_number'] }}"></label>
    <label>Category
      <select name="job_category">
        {% for opt in ["Domestic","Drilling","Ag","Electrical"] %}
          <option value="{{ opt }}" {% if job['job_category']==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Description<textarea name="description" rows="3">{{ job['description'] }}</textarea></label>
    <button>Save Job</button>
  </form>
</section>
<section class="card">
  <h3>Job Photos</h3>
  <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_job_photo', site_id=site['id'], job_id=job['id']) }}">
    <input type="file" name="photo" accept="image/*" required>
    <input type="text" name="caption" placeholder="Caption (optional)">
    <button>Upload</button>
  </form>
  <div class="photos">{% for p in jphotos %}<figure><img src="{{ url_for('uploaded_file', filename=p['filename']) }}"><figcaption>{{ p['caption'] or '' }}</figcaption></figure>{% else %}<p>No photos.</p>{% endfor %}</div>
</section>
<section class="card">
  <h3>Job Notes</h3>
  <form method="post" action="{{ url_for('add_job_note', site_id=site['id'], job_id=job['id']) }}">
    <textarea name="body" rows="2" placeholder="Add a note..."></textarea><button>Add</button>
  </form>
  <ul class="notes">{% for n in jnotes %}<li><small>{{ n['created_at'] }}</small> — {{ n['body'] }}</li>{% else %}<li>No notes.</li>{% endfor %}</ul>
</section>

<section class="card">
  <h3>Share</h3>
  <button id="shareJobBtn" type="button">Create Share Link (This Job Only)</button>
  <input id="shareJobOut" style="width:100%;margin-top:6px" placeholder="Share link will appear here..." readonly>
</section>
<script>
  document.getElementById('shareJobBtn').addEventListener('click', async () => {
    const resp = await fetch('{{ url_for("create_job_share", site_id=site["id"], job_id=job["id"]) }}', {method:'POST'});
    const data = await resp.json();
    document.getElementById('shareJobOut').value = data.url;
    try { await navigator.clipboard.writeText(data.url); } catch(e) {}
  });
</script>

</main>
</body></html>
