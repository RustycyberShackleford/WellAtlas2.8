<!doctype html>
<html>
<head>
  <title>{{ header_title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
<header>
  <h1 id="appTitle">{{ header_title }}</h1>
  <nav><a href="{{ url_for('deleted_sites') }}">Deleted Sites</a> | <a href="{{ url_for('customers_index') }}">Customers</a></nav>
  <form id="searchForm" onsubmit="return false;">
    <input id="searchInput" placeholder="Search sites & notes">
    <select id="jobFilter">
      <option value="">All Jobs</option>
      <option>Domestic</option><option>Drilling</option><option>Ag</option><option>Electrical</option>
    </select>
    <select id="customerFilter"><option value="">All Customers</option></select>
    <button type="button" onclick="refreshSites()">Search</button>
  </form>
</header>
<main>
  <div id="map"></div>
</main>
<script>
let map=L.map('map').setView([39.9,-122.0],9);
L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key={{ maptiler_key }}`, {attribution: '&copy; MapTiler &copy; OpenStreetMap contributors'}).addTo(map);
let markersLayer=L.layerGroup().addTo(map);

async function loadCustomers(){
  const r=await fetch('/api/customers'); const data=await r.json();
  const sel=document.getElementById('customerFilter');
  sel.innerHTML='<option value="">All Customers</option>'+data.map(c=>`<option>${c.name}</option>`).join('');
}

async function refreshSites(){
  markersLayer.clearLayers();
  const q=document.getElementById('searchInput').value;
  const job=document.getElementById('jobFilter').value;
  const cust=document.getElementById('customerFilter').value;
  const resp=await fetch(`/api/sites?q=${encodeURIComponent(q)}&job=${encodeURIComponent(job)}&customer=${encodeURIComponent(cust)}`);
  const data=await resp.json();
  const ms=[];
  data.forEach(s=>{
    if(s.latitude && s.longitude){
      const m=L.marker([s.latitude, s.longitude]);
      const html=`<strong>${s.customer} â€” ${s.name}</strong><br><a href="/site/${s.id}">View site</a>`;
      m.bindPopup(html);
      markersLayer.addLayer(m);
      ms.push(m);
    }
  });
  if(ms.length){ const g=L.featureGroup(ms); map.fitBounds(g.getBounds().pad(0.2)); }
}
document.getElementById('jobFilter').addEventListener('change', refreshSites);
document.getElementById('customerFilter').addEventListener('change', refreshSites);
loadCustomers(); refreshSites();
</script>
</body>
</html>
